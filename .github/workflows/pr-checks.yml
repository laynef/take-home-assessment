name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      workflows: ${{ steps.changes.outputs.workflows }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          frontend:
            - 'frontend/**'
          backend:
            - 'backend/**'
          workflows:
            - '.github/workflows/**'

  frontend-validation:
    name: Frontend Validation
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.workflows == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Check for TODO sections
      run: |
        echo "Checking for remaining TODO sections..."
        cd frontend/src/components
        if grep -r "TODO" . --exclude-dir=node_modules; then
          echo "âŒ Found TODO sections in components. Please complete implementation."
          exit 1
        else
          echo "âœ… No TODO sections found in components."
        fi

    - name: Validate component structure
      run: |
        echo "Validating component structure..."
        cd frontend/src/components
        required_components=("PatientList.js" "PatientDetail.js" "ConsentManagement.js" "TransactionHistory.js" "StatsDashboard.js")

        for component in "${required_components[@]}"; do
          if [ ! -f "$component" ]; then
            echo "âŒ Missing required component: $component"
            exit 1
          else
            echo "âœ… Found component: $component"
          fi
        done

    - name: Run tests with detailed output
      id: tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false --verbose --testResultsProcessor=jest-junit
        echo "TEST_EXIT_CODE=0" >> $GITHUB_ENV
      env:
        CI: true
      continue-on-error: true

    - name: Upload test coverage for forked PRs
      uses: actions/upload-artifact@v3
      if: always() && github.event.pull_request.head.repo.full_name != github.repository
      with:
        name: fork-pr-coverage-${{ github.event.number }}
        path: frontend/coverage/

    - name: Upload test results for forked PRs
      uses: actions/upload-artifact@v3
      if: always() && github.event.pull_request.head.repo.full_name != github.repository
      with:
        name: fork-pr-test-results-${{ github.event.number }}
        path: frontend/coverage/
        if-no-files-found: warn

    - name: Upload build artifacts for forked PRs
      uses: actions/upload-artifact@v3
      if: always() && github.event.pull_request.head.repo.full_name != github.repository && steps.build.outcome == 'success'
      with:
        name: fork-pr-build-${{ github.event.number }}
        path: frontend/build/
        if-no-files-found: warn

    - name: Check test coverage
      run: |
        cd frontend
        if [ -f coverage/lcov.info ]; then
          echo "âœ… Test coverage generated"
          # Check if coverage is above 80%
          if npm run coverage:check 2>/dev/null; then
            echo "âœ… Test coverage meets requirements"
          else
            echo "âš ï¸  Test coverage may be low"
          fi
        else
          echo "âš ï¸  No coverage report generated"
        fi

    - name: Handle test failure
      if: steps.tests.outcome == 'failure'
      run: |
        echo "TEST_EXIT_CODE=1" >> $GITHUB_ENV

    - name: Build frontend
      id: build
      run: |
        cd frontend
        npm run build
        echo "BUILD_EXIT_CODE=0" >> $GITHUB_ENV
      env:
        CI: false
      continue-on-error: true

    - name: Handle build failure
      if: steps.build.outcome == 'failure'
      run: |
        echo "BUILD_EXIT_CODE=1" >> $GITHUB_ENV

    - name: Fail job if tests or build failed
      if: steps.tests.outcome == 'failure' || steps.build.outcome == 'failure'
      run: |
        echo "âŒ Job failing due to test or build failures"
        echo "Test outcome: ${{ steps.tests.outcome }}"
        echo "Build outcome: ${{ steps.build.outcome }}"
        exit 1

    - name: Comment PR with test results
      uses: actions/github-script@v6
      if: always() && github.event.pull_request.head.repo.full_name == github.repository
      with:
        script: |
          const testOutcome = '${{ steps.tests.outcome }}';
          const buildOutcome = '${{ steps.build.outcome }}';

          let comment = "## ğŸ§ª Frontend Test Results\n\n";

          // Add test status
          if (testOutcome === 'success') {
            comment += "âœ… **All tests passed!**\n\n";
          } else {
            comment += "âŒ **Some tests failed!**\n\n";
          }

          comment += "### Test Coverage\n";
          comment += "Coverage reports have been generated and uploaded as artifacts.\n\n";

          comment += "### Build Status\n";
          if (buildOutcome === 'success') {
            comment += "âœ… **Build successful!**\n\n";
          } else {
            comment += "âŒ **Build failed!**\n\n";
          }

          comment += "### Assessment Validation\n";
          comment += "- âœ… All required components are present\n";
          comment += "- âœ… No TODO sections remaining\n";
          comment += "- âœ… Component structure is valid\n\n";

          comment += "*This comment was automatically generated by the CI/CD pipeline.*";

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Log test results for forked PRs
      if: always() && github.event.pull_request.head.repo.full_name != github.repository
      run: |
        echo "## ğŸ§ª Frontend Test Results (Forked PR)"
        echo "================================="
        echo "Note: This PR is from a forked repository (${{ github.event.pull_request.head.repo.full_name }})"
        echo "Automatic PR comments are disabled for security reasons."
        echo ""
        echo "ğŸ“Š **Test Status:** ${{ steps.tests.outcome }}"
        echo "ğŸ—ï¸ **Build Status:** ${{ steps.build.outcome }}"
        echo "ğŸ”— **PR Number:** #${{ github.event.number }}"
        echo "ğŸ·ï¸  **Branch:** ${{ github.event.pull_request.head.ref }}"
        echo ""
        echo "ğŸ“ **Available Artifacts:**"
        echo "  - fork-pr-coverage-${{ github.event.number }}"
        echo "  - fork-pr-test-results-${{ github.event.number }}"
        if [ "${{ steps.build.outcome }}" == "success" ]; then
          echo "  - fork-pr-build-${{ github.event.number }}"
        fi
        echo ""
        echo "ğŸ’¡ **For maintainers:** Download artifacts above for detailed test and coverage reports."
        echo "================================="

  backend-compatibility:
    name: Backend Compatibility Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.workflows == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Start backend server
      run: |
        cd backend
        PORT=5001 npm start &
        sleep 10
      env:
        NODE_ENV: test

    - name: Test API endpoints
      run: |
        echo "Testing API endpoints..."
        curl -f http://localhost:5001/api/health || exit 1
        curl -f http://localhost:5001/api/patients || exit 1
        curl -f http://localhost:5001/api/stats || exit 1
        echo "âœ… All API endpoints accessible"

    - name: Stop backend server
      run: |
        pkill -f "node.*server.js" || true

  assessment-requirements:
    name: Assessment Requirements Check
    runs-on: ubuntu-latest
    needs: [frontend-validation]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate README documentation
      run: |
        echo "Checking README documentation..."
        if grep -q "Screenshots" README.md; then
          echo "âœ… Screenshots section found in README"
        else
          echo "âš ï¸  Screenshots section missing in README"
        fi

        if grep -q "Implementation Summary" README.md; then
          echo "âœ… Implementation summary found in README"
        else
          echo "âš ï¸  Implementation summary missing in README"
        fi

    - name: Check for required test files
      run: |
        echo "Checking for test files..."
        if [ -f "frontend/src/assessment.test.js" ]; then
          echo "âœ… Assessment tests found"
        else
          echo "âŒ Missing assessment.test.js"
          exit 1
        fi

        if [ -f "frontend/src/setupTests.js" ]; then
          echo "âœ… Test setup configuration found"
        else
          echo "âŒ Missing setupTests.js"
          exit 1
        fi

    - name: Validate project structure
      run: |
        echo "Validating project structure..."
        required_dirs=("frontend/src/components" "frontend/src/hooks" "frontend/src/services" "backend/controllers" "backend/routes")

        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… Directory found: $dir"
          else
            echo "âŒ Missing directory: $dir"
            exit 1
          fi
        done

    - name: Final assessment status
      run: |
        echo "ğŸ¯ Assessment Requirements Validation Complete!"
        echo "âœ… All core requirements have been met"
        echo "âœ… Test suite is comprehensive and passing"
        echo "âœ… Documentation is complete"
        echo "âœ… Project structure follows specifications"